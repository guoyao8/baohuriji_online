import{a as G,f as E,j as e,z as J}from"./index-B2L3e1xg.js";import{u as L,r as l}from"./react-vendor-CA3giask.js";import{f as h,s as v,j as Y}from"./date-utils-BxdteZ_p.js";import"./store-DH4KNu1b.js";import"./http-B9ygI19o.js";const C="stats_cache",S="trend_cache",k=5*60*1e3,N=u=>{try{const d=localStorage.getItem(u);return d?JSON.parse(d):{}}catch{return{}}},A=(u,d)=>{try{localStorage.setItem(u,JSON.stringify(d))}catch{}};function X(){const u=L(),{babies:d}=G(),[c,M]=l.useState("day"),[f,D]=l.useState(new Date),[H,y]=l.useState(!1),[w,F]=l.useState(()=>N(C)),[z,K]=l.useState(()=>N(S)),[_,$]=l.useState(()=>{const t=h(new Date,"yyyy-MM-dd"),s=N(C)[t];return s&&Date.now()-s.timestamp<k?s.data:[]}),[b,I]=l.useState(()=>{const t=N(S),s=h(new Date,"yyyy-MM-dd"),i=Object.keys(t).find(a=>a.includes(s));if(i){const a=t[i];if(a&&Date.now()-a.timestamp<k)return a.data}return[]});l.useEffect(()=>{O()},[f,d,c]);const O=l.useCallback(async()=>{try{const t=h(f,"yyyy-MM-dd"),s=Date.now(),i=t,a=w[i],m=a&&s-a.timestamp<k;if(a&&$(a.data),!m){a||y(!0);const g=await E.getDailyStats(t);$(g);const j={...w,[i]:{data:g,timestamp:s}};F(j),A(C,j)}const p=d.map(g=>g.id);let n,o;c==="day"?(n=h(f,"yyyy-MM-dd"),o="hour"):(n=h(v(f,6),"yyyy-MM-dd"),o="day");const r=`${n}_${t}_${o}_${p.join(",")}`,x=z[r],V=x&&s-x.timestamp<k;if(x&&I(x.data),V)y(!1);else{const g=await E.getTrend({startDate:n,endDate:t,babyIds:p,groupBy:o});I(g);const j={...z,[r]:{data:g,timestamp:s}};K(j),A(S,j),y(!1)}}catch(t){console.error("Failed to load stats:",t),y(!1)}},[f,c,d,w,z]),P=l.useCallback(()=>{D(t=>v(t,c==="day"?1:7))},[c]),R=l.useCallback(()=>{D(t=>Y(t,c==="day"?1:7))},[c]),T=l.useMemo(()=>{if(b.length===0)return 300;const t=Math.max(...b.flatMap(s=>s.babies.map(i=>i.amount||0)));return Math.max(t,100)},[b]);return e.jsxs("div",{className:"relative flex h-auto min-h-screen w-full flex-col",children:[e.jsxs("div",{className:"pb-24",children:[e.jsxs("div",{className:"flex items-center bg-background-light dark:bg-background-dark p-4 pb-2 justify-between sticky top-0 z-10",children:[e.jsx("div",{className:"flex size-12 shrink-0 items-center justify-start",children:e.jsx("button",{onClick:()=>u(-1),children:e.jsx("span",{className:"material-symbols-outlined text-zinc-900 dark:text-white",children:"arrow_back_ios_new"})})}),e.jsx("h1",{className:"text-zinc-900 dark:text-white text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center",children:"统计"}),e.jsx("div",{className:"flex w-12 items-center justify-end"})]}),e.jsx("div",{className:"flex px-4 py-3",children:e.jsxs("div",{className:"flex h-10 flex-1 items-center justify-center rounded-lg bg-zinc-200 dark:bg-zinc-800 p-1",children:[e.jsxs("label",{className:"flex cursor-pointer h-full grow items-center justify-center overflow-hidden rounded-lg px-2 has-[:checked]:bg-background-light has-[:checked]:dark:bg-background-dark has-[:checked]:shadow-sm has-[:checked]:text-zinc-900 has-[:checked]:dark:text-white text-zinc-500 dark:text-zinc-400 text-sm font-medium leading-normal",children:[e.jsx("span",{className:"truncate",children:"日"}),e.jsx("input",{checked:c==="day",onChange:()=>M("day"),className:"invisible w-0",type:"radio",name:"time-range"})]}),e.jsxs("label",{className:"flex cursor-pointer h-full grow items-center justify-center overflow-hidden rounded-lg px-2 has-[:checked]:bg-background-light has-[:checked]:dark:bg-background-dark has-[:checked]:shadow-sm has-[:checked]:text-zinc-900 has-[:checked]:dark:text-white text-zinc-500 dark:text-zinc-400 text-sm font-medium leading-normal",children:[e.jsx("span",{className:"truncate",children:"周"}),e.jsx("input",{checked:c==="week",onChange:()=>M("week"),className:"invisible w-0",type:"radio",name:"time-range"})]})]})}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-2",children:[e.jsx("button",{onClick:P,className:"p-2 text-zinc-500 dark:text-zinc-400",children:e.jsx("span",{className:"material-symbols-outlined",children:"chevron_left"})}),e.jsx("h4",{className:"text-zinc-500 dark:text-zinc-400 text-sm font-bold leading-normal tracking-[0.015em] text-center",children:c==="day"?h(f,"MM月dd日",{locale:J}):`${h(v(f,6),"MM月dd日")} - ${h(f,"MM月dd日")}`}),e.jsx("button",{onClick:R,className:"p-2 text-zinc-500 dark:text-zinc-400",children:e.jsx("span",{className:"material-symbols-outlined",children:"chevron_right"})})]}),d.length>0&&e.jsx("div",{className:"flex items-center justify-center gap-4 px-4 pt-2 pb-4",children:d.map(t=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`size-3 rounded-full ${t.gender==="male"?"bg-blue-500":"bg-pink-500"}`}),e.jsx("span",{className:"text-sm font-medium text-zinc-900 dark:text-white",children:t.name})]},t.id))}),e.jsx("div",{className:"flex flex-wrap gap-4 px-4",children:_.map(t=>e.jsxs("div",{className:"flex min-w-[158px] flex-1 flex-col gap-2 rounded-xl p-4 border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-900/50",children:[e.jsxs("p",{className:"text-zinc-600 dark:text-zinc-400 text-base font-medium leading-normal",children:[t.babyName," 总量"]}),e.jsxs("p",{className:"text-zinc-900 dark:text-white tracking-light text-2xl font-bold leading-tight",children:[t.totalAmount,"ml"]})]},t.babyId))}),e.jsx("div",{className:"flex flex-wrap gap-4 p-4",children:_.map(t=>e.jsxs("div",{className:"flex min-w-[158px] flex-1 flex-col gap-2 rounded-xl p-4 border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-900/50",children:[e.jsxs("p",{className:"text-zinc-600 dark:text-zinc-400 text-base font-medium leading-normal",children:[t.babyName," 频率"]}),e.jsxs("p",{className:"text-zinc-900 dark:text-white tracking-light text-2xl font-bold leading-tight",children:[t.totalFeedings,"次"]})]},`freq-${t.babyId}`))}),e.jsx("div",{className:"px-4 py-2",children:e.jsxs("div",{className:"rounded-xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-900/50 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-base font-bold text-zinc-900 dark:text-white",children:["喂养量趋势 ",c==="day"?"(今日24小时)":"(过去7天)"]}),H&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-zinc-500 dark:text-zinc-400",children:[e.jsx("span",{className:"animate-spin material-symbols-outlined",style:{fontSize:"16px"},children:"progress_activity"}),"加载中..."]})]}),e.jsx("div",{className:"flex h-48 w-full items-end justify-between gap-1 text-xs text-zinc-500 dark:text-zinc-400",children:c==="day"?Array.from({length:12}).map((t,s)=>{const i=s*2,a=i+2,m={babies:[]},p=new Map;for(let n=i;n<a;n++){const o=b.find(r=>r.hour===n);o&&o.babies&&o.babies.forEach(r=>{const x=p.get(r.babyId);x?x.amount+=r.amount:p.set(r.babyId,{...r})})}return m.babies=Array.from(p.values()),e.jsxs("div",{className:"flex h-full flex-col items-center justify-end gap-1 flex-1",children:[e.jsx("div",{className:"flex w-full h-full items-end justify-center gap-0.5",children:m.babies.length>0?m.babies.map(n=>{const o=m.babies.length===1?"w-full":"w-1/2",r=n.babyGender==="male"?"bg-blue-500":"bg-pink-500",x=n.amount/T*100;return e.jsx("div",{className:"relative flex flex-col items-center justify-end h-full",style:{width:m.babies.length===1?"100%":"50%"},children:e.jsx("div",{className:`${o} ${r} rounded-t relative`,style:{height:`${x}%`,minHeight:n.amount>0?"6px":"0"},children:n.amount>0&&e.jsxs("div",{className:"absolute -top-4 left-1/2 transform -translate-x-1/2 text-[9px] font-medium text-zinc-700 dark:text-zinc-300 whitespace-nowrap",children:[n.amount,"ml"]})})},n.babyId)}):e.jsx("div",{className:"w-full rounded-t bg-zinc-200 dark:bg-zinc-700",style:{height:"0%"}})}),e.jsx("span",{className:"text-[9px]",children:i.toString().padStart(2,"0")})]},i)}):b.map(t=>e.jsxs("div",{className:"flex h-full w-full flex-col items-center justify-end gap-2",children:[e.jsx("div",{className:"flex w-full h-full items-end justify-center gap-1",children:t.babies.length>0?t.babies.map(s=>{const i=t.babies.length===1?"w-full":"w-1/2",a=s.babyGender==="male"?"bg-blue-500":"bg-pink-500",m=s.amount/T*100;return e.jsx("div",{className:"relative flex flex-col items-center justify-end h-full",style:{width:t.babies.length===1?"100%":"50%"},children:e.jsx("div",{className:`${i} ${a} rounded-t relative`,style:{height:`${m}%`,minHeight:s.amount>0?"8px":"0"},children:s.amount>0&&e.jsxs("div",{className:"absolute -top-5 left-1/2 transform -translate-x-1/2 text-[10px] font-medium text-zinc-700 dark:text-zinc-300 whitespace-nowrap",children:[s.amount,"ml"]})})},s.babyId)}):e.jsx("div",{className:"w-full rounded-t bg-zinc-200 dark:bg-zinc-700",style:{height:"0%"}})}),e.jsx("span",{className:"text-[10px]",children:t.date?h(new Date(t.date),"MM/dd"):""})]},t.date))}),e.jsx("p",{className:"text-xs text-zinc-500 dark:text-zinc-400 mt-4",children:"只统计奶粉和母乳，母乳按照近3天平均值计算。"})]})})]}),e.jsx("nav",{className:"fixed bottom-0 left-0 right-0 z-10 border-t border-zinc-200 dark:border-zinc-800 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm pb-safe",children:e.jsxs("div",{className:"grid h-16 grid-cols-3",children:[e.jsxs("button",{onClick:()=>u("/"),className:"flex flex-col items-center justify-center gap-1 text-zinc-500 dark:text-zinc-400",children:[e.jsx("span",{className:"material-symbols-outlined",children:"home"}),e.jsx("span",{className:"text-xs font-medium",children:"主页"})]}),e.jsxs("button",{onClick:()=>u("/stats"),className:"flex flex-col items-center justify-center gap-1 text-primary dark:text-primary",children:[e.jsx("span",{className:"material-symbols-outlined",children:"bar_chart"}),e.jsx("span",{className:"text-xs font-medium",children:"统计"})]}),e.jsxs("button",{onClick:()=>u("/settings"),className:"flex flex-col items-center justify-center gap-1 text-zinc-500 dark:text-zinc-400",children:[e.jsx("span",{className:"material-symbols-outlined",children:"person"}),e.jsx("span",{className:"text-xs font-medium",children:"我的"})]})]})})]})}export{X as default};
